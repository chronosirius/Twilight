<!DOCTYPE html>
<html translate="no">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.5/mousetrap.min.js" integrity="sha512-+Jg3Ynmj9hse704K48H6rBBI3jdNBjReRGBCxUWFfOz3yVurnJFWtAWssDAsGtzWYw89xFWPxShuj2T6E9EOpg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="/static/ctxmenu.js"></script>
        <script src="/static/modal.js"></script>
        <script src="/static/twilightlib.js"></script>
        <title>{% block title %}{% endblock %} | {{ appname }}</title>
        <style>
            /* basic styles that will show up everywhere */
            @import url("https://fonts.googleapis.com/css2?family=Ubuntu&family=Open+Sans&display=block");

            * {
                font-family: 'Ubuntu', sans-serif;
                hyphens: auto;
                hyphenate-character: "-";
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --spec-el-color: #232323;
                    --background-color: #454545;
                    --tlv-el-color: #343434;
                    --thlv-el-color: #404040;
                    --disc-color: #666666;
                    --text-color: white;
                    --invert-color: white;
                    --invert-text-color: black;
                    --makefriend-color: yellow;
                }
            }

            @media (prefers-color-scheme: light) {
                :root {
                    --spec-el-color: #bfbfbf;
                    --background-color: #ffffff;
                    --tlv-el-color: #cbcbcb;
                    --thlv-el-color: #dcdcdc;
                    --disc-color: #777777;
                    --text-color: black;
                    --invert-color: white;
                    --invert-text-color: black;
                    --makefriend-color: red;
                }
            }

            @keyframes flash {
                0% {
                    background-color: #002277;
                }
                100% {
                    background-color: previous;
                }
            }

            .flash {
                animation: flash 1s;
            }

            @keyframes zoom {
                0% {
                    transform: scale(0.25);
                }
                100% {
                    transform: scale(1);
                }
            }

            .zoomin {
                animation: zoom 250ms;
                animation-fill-mode: forwards;
                transition: .5s;
                transform-origin: center;
                transform: scale(1.0);
            }

            .zoomout {
                animation: zoom 250ms;
                animation-fill-mode: backwards;
                transition: .5s;
                transform-origin: center;
                transform: scale(1.0);
            }

            body {
                padding: 0px;
                margin: 0px;
                border: 0px;
                background-color: var(--background-color);
                height: 100vh;
                width: 100vw;
            }

            div#sidebar {
                background: var(--spec-el-color);
                position: fixed;
                height: 100%;
                top: 0px;
                left: 0px;
                overflow-y: scroll;
                width: 75px;
            }

            div#sidebar::-webkit-scrollbar {
                display: none;
            }

            div#topbar {
                background-color: var(--tlv-el-color);
                width: calc(100% - 75px);
                height: 6vh;
                position: relative;
                top: 0px;
                left: 75px;
                text-align: right;
                z-index: 10;
                border-bottom: black 1px;
            }

            div#topbar::before {
                content:'';
                z-index: -1;
                position:absolute;
                top:0;
                left:0;
                bottom:0;
                right:0;
                clip-path: inset(0px 0px -3px 0px);
                box-shadow: 0px 0px 50px rgba(0,0,0,0.20);
                /*pointer-events: none;*/
            }

            div#subbody {
                position: absolute;
                left: 75px;
                width: calc(100% - 75px);
                height: 94vh;
                bottom: 0;
                top:6vh;
                overflow: hidden;
            }

            div#sidebar-pdm {
                background-color: var(--thlv-el-color);
                position: relative;
                top: 0px;
                left: 0px;
                height: 100%;
                width: 20%;
            }

            div#myinfo {
                text-align: left;
                color: var(--text-color);
                max-width: 100%;
                max-height: 53.5104px;
                min-width: 0;
                display: flex;
                background-color: var(--tlv-el-color);
                position: absolute;
                bottom: 0px;
                left:0;
                right:0;
                height: 10%;
                align-items: center;
                justify-content: space-evenly;
            }

            div#myinfo p {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            div#myinfo img {
                vertical-align: middle;
                border-radius: 35%;
                height: 100%;
                cursor:pointer;
                transform: scale(1);
                transition: transform 100ms linear;
            }

            div#myinfo img:hover {
                transform: scale(1.05);
                transition: all 100ms ease-out;
            }

            div#myinfo img:active {
                transform: scale(1.1) translateZ(0);
                box-shadow: 0px 0px 5px darkcyan;
            }

            div#myinfo div {
                flex:1 1 0;
                min-width: 0;
                max-width: min-content;
                padding: 3%;
            }

            div#sidebar-lim {
                height: 90%;
                top: 0;
                overflow-y: scroll;
                max-width: 100%;
            }

            div#sidebar-lim::-webkit-scrollbar {
                display: none;
            }

            div#subsubbody {
                position: absolute;
                left: 20%;
                height: 100%;
                top: 0;
                width: 80%;
                color: var(--text-color);
                overflow-y: auto;
                bottom: 0;
            }

            .texthr {
                display: flex;
                align-items: center;
                text-align: center;
            }

            .texthr::before, .texthr::after {
                content: '';
                flex:1;
                border-bottom: 1px solid var(--text-color);
            }

            .texthr:not(:empty)::before {
                margin-right: .25em;
            }

            .texthr:not(:empty)::after {
                margin-left: .25em;
            }

            .texthr .texthr-text {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                color: var(--text-color);
                user-select: none;
            }

            a {
                -webkit-user-drag: none;
                user-select:none;
            }

            img {
                -webkit-user-drag: none;
                user-select:none;
            }

            hr {
                background-color: var(--text-color);
                height: 1px;
                border: none;
            }

            #me-sidebar-icon {
                width:80%;
                display: block; 
                margin-left: auto; 
                margin-right: auto;
                border-radius: 25%; 
                margin-top: 10%;
                transition: transform 100ms ease-out;
            }

            #me-sidebar-icon:hover {
                transform: scale(1.1);
                transition: all 250ms ease-in;
            }

            #me-sidebar-icon:active {
                transform: scale(1.12);
                box-shadow: 1px 1px 5px darkblue;
            }

            .server-sidebar-icon img {
                width: 80%;
                object-position: center;
                object-fit: cover;
                border-radius: 25%;
                margin-left:auto;
                margin-right:auto;
                display:block;
                transform: scale(1);
                transition: transform 150ms ease-out;
            }

            .server-sidebar-icon img:hover {
                transform: scale(1.1);
                transition: all 250ms ease-in;
            }

            .server-sidebar-icon img:active {
                transform: scale(1.15);
                box-shadow: 1px 1px 5px darkblue;
            }
        </style>
        {% block styles %}{% endblock %}
        {% block headscripts %}{% endblock %}
    </head>
    <body>
        <noscript><div style='position: fixed; overflow: none; width: 100vw; height: 100vh; background-color: white; z-index: 1000; top: 0; text-align: center;'><h1 style="color: orange;">This site requires JavaScript to function. Please enable it.</h1></div></noscript>
        <script async>
            //gets token
            window.token = Object.fromEntries(new URLSearchParams(document.cookie.replace(/; /g, "&")))['authtoken']
            window.self_id = "{{ user['id'] }}"
        </script>
        <script async>
            form = new FormData()
            form.append('token', token)
            prefstat = localStorage.getItem('prefstat')
            
            if (prefstat == null) {
                form.append('status', 'online')
            } else {
                form.append('status', prefstat)
            }

            fetch("{{ url_for('locked.me.update_status') }}", {
                method: 'POST',
                body: form
            }).then(function(res) {
                return res.json()
            }).then(function(json) {
                if (json['error'] == null) {
                    console.log('Update successful!')
                } else {
                    location.reload()
                }
            })
            
            window.addEventListener('beforeunload', function() {
                fd = new FormData()
                fd.append('token', token)
                fd.append('status', 'offline')
                navigator.sendBeacon("{{ url_for('locked.me.update_status') }}", fd)
            })
        </script>
        
        <script>
            console.log(token)
            function new_server_modal() {
                if (document.getElementById('new_server_modal') == null) {
                    modal_t = new Modal('new_server_modal', 'Create a server', [
                        {
                            element_type: 'input',
                            type: 'hidden',
                            name: 'token',
                            prefilled: token,
                            custom_id: 'token'
                        },
                        {
                            element_type: 'input',
                            type: 'text',
                            name: 'servername',
                            placeholder: 'Server Name',
                            custom_id: "servername",
                            attributes: {
                                required: true,
                                autocomplete: 'off'
                            }
                        },
                        {
                            element_type: 'break'
                        },
                        {
                            element_type: 'break'
                        },
                        {
                            element_type: 'input',
                            type: 'file',
                            name: 'icon',
                            custom_id: 'icon',
                            attributes: {
                                'accept': 'image/jpeg,image/png,image/bmp,image/webp,image/gif'
                            }
                        }
                    ], true, {
                        action: "{{ url_for('locked.servers.server_create') }}",
                        method: 'POST',
                        attributes: {
                            enctype: 'multipart/form-data'
                        }
                    })
                    modal_t.show()
                }
            }

            function update_status() {
                modal_t = new Modal('status_modal', 'Set Your Status', [
                    {
                        element_type: "input",
                        placeholder: 'New Status',
                        name: 'status',
                        id: 'status_input',
                        attributes: {
                            required: 'true',
                            autocomplete: 'off'
                        }
                    },
                    {
                        element_type: "break"
                    },
                    {
                        element_type: 'break'
                    },
                    {
                        element_type: 'button',
                        text: 'Change Status',
                        callback: function(ctx) {
                            stat = ctx.inputs['status'].value
                            if (stat != '') {
                                localStorage.setItem('prefstat', stat)
                                form = new FormData()
                                form.append('token', token)
                                form.append('status', stat)
                                fetch('{{ url_for("locked.me.update_status") }}', {
                                    method: 'POST',
                                    body: form
                                })
                                ctx.modal.close()
                                setTimeout(() => alert('Done!'), 100)
                            } else {
                                alert('Please fill all fields!')
                                ctx.inputs['status'].focus()
                            }
                        },
                        custom_id: 'change_status'
                    },
                    {
                        element_type: 'button',
                        text: 'Reset Status',
                        custom_id: 'reset_status',
                        callback: function(ctx) {
                            localStorage.removeItem('prefstat')
                            form = new FormData()
                            form.append('token', token)
                            form.append('status', 'online')
                            fetch('{{ url_for("locked.me.update_status") }}', {
                                method: 'POST',
                                body: form
                            })
                            ctx.modal.close()
                            setTimeout(() => alert('Reset successful.'), 100)
                        }
                    }
                ])
                modal_t.show()
            }
        </script>
        <div id="sidebar">
            <a href="/me/">
                <img src="/favicon.ico" id="me-sidebar-icon">
            </a>{% for server in servers %}
            <br>
            <a href="{{ server['link'] }}" class="server-sidebar-icon" id="{{ server['id'] }}" server="{{ server['id'] }}">
                <div style="display:block; margin-left:auto;margin-right:auto;">
                    <img src="{{ server['icon'] }}" server="{{ server['id'] }}">
                </div>
            </a>{% endfor %}
            <br>
            <button onclick="new_server_modal()" style="display: block; margin-left: auto; margin-right: auto; border-radius: 25%; width: 80%; height: 9.5%; font-size: 200%; background: #28d3f3; cursor: pointer;" onmouseover="this.style.background='#72d3f3'" onmouseleave="this.style.background='#28d3f3'">&#43</button>
        </div>
        <div id="topbar">{% block topbar %}{% endblock %}</div>
        <div id="subbody">
            <div id="sidebar-pdm">
                <div id="sidebar-lim">
                {% block sidebar %}{% endblock %}
                </div>
                <div id="myinfo">
                    <div style="height:80%; text-align:center;">
                        <img src="{{ user['pfp_url'] }}" onclick="update_status()">
                    </div>
                    <div style="flex-shrink:100;">
                        <p style="margin:0;">{{ user['username'] }}</p>
                        <p style="margin:0; color: var(--disc-color);">#{{ user['discriminator'] }}</p>
                    </div>
                    <div style=" text-align:center;">
                        <a href='/' style="color: var(--text-color); text-decoration:none;"><span class="material-symbols-outlined">settings</span></a>
                    </div>
                </div>
            </div>
            <div id="subsubbody">
                {% block content %}{% endblock %}
            </div>
        </div>
        <!-- <script src="/firebug/build/firebug-lite-debug.js#startOpened=false"></script> -->
        <script defer>
            console.log('starting ezpagechange')
            Array.from(document.getElementsByTagName('a')).forEach(function(el) {
                console.log('registering', el)
                
                el.addEventListener('click', function(ev) {
                    ev.preventDefault()
                    redirect(ev.target.closest('a').getAttribute('href'))
                    console.log('clicked', ev.target.closest('a'))
                })
                console.log('registered', el)
            })
            console.log('registered')
        </script>
        {% block scripts %}{% endblock %}
    </body>
</html>